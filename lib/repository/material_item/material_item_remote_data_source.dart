import 'dart:convert';

import 'package:flutter/foundation.dart';
import 'package:flutter_se_test/db/DBProvider.dart';
import 'package:flutter_se_test/model/channel.dart';
import 'package:flutter_se_test/model/channer_response.dart';
import 'package:flutter_se_test/model/material_item.dart';
import 'package:flutter_se_test/model/news.dart';
import 'package:flutter_se_test/repository/material_item/dao/material_item_dao.dart';
import 'package:http/http.dart' as http;

class MaterialItemRemoteDataSource{
  final http.Client httpClient;
  final matItemDao = MaterialItemDao();

  MaterialItemRemoteDataSource({@required this.httpClient});

  Future<List<MaterialItem>> getLastMaterials() async {

    final String materialUrl = 'https://www.sport-express.ru/services/materials/mobile/?mainOnly%5Bphoto%5D=1&items=30&mainOnly%5Bvideo%5D=1&json=1&itemsloaded=0&mainOnly%5Bpress%5D=1&siteRubricIds=1873%2C3956%2C6432%2C16829%2C1875%2C1877%2C1878%2C1879%2C1908%2C1909%2C1910%2C5670%2C6201%2C1912%2C1913%2C1882%2C1883%2C1884%2C1885%2C1886%2C1887%2C1888%2C1889%2C1890%2C1891%2C1892%2C1893%2C1894%2C1895%2C1896%2C1897%2C1898%2C1899%2C1900%2C1901%2C1902%2C1903%2C1904%2C1905%2C1906%2C1907%2C2127%2C5620%2C5669%2C5734%2C5830%2C5905%2C5906%2C5938%2C5939%2C6050%2C6095%2C6097%2C6098%2C6106%2C6110%2C6119%2C6121%2C6222%2C6345%2C6424%2C6443%2C17094%2C17115%2C3972%2C16835%2C1915%2C1916%2C1917%2C1918%2C1919%2C1920%2C1921%2C1922%2C1923%2C1924%2C1925%2C6241%2C6289%2C6347%2C6478%2C16596%2C16837%2C17121%2C1928%2C1929%2C1930%2C1931%2C1932%2C16747%2C16748%2C16804%2C16805%2C1935%2C1936%2C1937%2C1938%2C1939%2C1940%2C1941%2C5935%2C1942%2C1943%2C17126%2C17127%2C17128%2C17129%2C6234%2C16958%2C16959%2C16960%2C1945%2C1946%2C1947%2C16802%2C16803%2C16735%2C16736%2C16808%2C16809%2C1951%2C1952%2C1953%2C1954%2C6090%2C6091%2C1808%2C16839%2C1955%2C1956%2C1957%2C1958%2C1810%2C1818%2C1964%2C1965%2C1966%2C1967%2C1968%2C1969%2C1970%2C1971%2C1972%2C1973%2C1974%2C1975%2C1976%2C1977%2C2329%2C3246%2C3247%2C3248%2C3249%2C3250%2C3251%2C3252%2C3253%2C3254%2C3255%2C3256%2C3257%2C3258%2C3259%2C3260%2C3262%2C3263%2C3264%2C3266%2C3267%2C3268%2C3269%2C3270%2C3271%2C3272%2C3273%2C3274%2C3275%2C3276%2C3278%2C3279%2C3280%2C3282%2C3284%2C3285%2C3286%2C3287%2C3288%2C3289%2C3347%2C5739%2C5741%2C5815%2C5816%2C5817%2C5818%2C5819%2C5820%2C5821%2C5822%2C5823%2C5824%2C5825%2C5826%2C5827%2C5974%2C1961%2C1978%2C1979%2C1980%2C1981%2C1982%2C1983%2C1984%2C1985%2C1986%2C1987%2C1988%2C1989%2C1990%2C1991%2C1992%2C1993%2C1994%2C1995%2C1996%2C1997%2C1998%2C1999%2C2000%2C2001%2C2002%2C2003%2C2004%2C2005%2C2006%2C2007%2C2008%2C2009%2C2010%2C2011%2C2012%2C2013%2C2014%2C3061%2C2030%2C2031%2C2032%2C6397%2C6400%2C16573%2C1813%2C1814%2C1815%2C1816%2C1819%2C1820%2C1821%2C2033%2C2034%2C1823%2C2035%2C2036%2C16810%2C16811%2C16812%2C16813%2C1825%2C1826%2C2039%2C2040%2C2041%2C1828%2C3099%2C3100%2C3101%2C1830%2C2042%2C2043%2C2044%2C2045%2C2046%2C2047%2C1832%2C1834%2C1835%2C1836%2C1837%2C1838%2C1839%2C1840%2C1841%2C1842%2C1843%2C1844%2C1845%2C1846%2C1847%2C1848%2C1849%2C2048%2C2049%2C1851%2C1852%2C1853%2C1854%2C1855%2C16952%2C16954%2C1857%2C1858%2C1859%2C1860%2C1861%2C1862%2C1863%2C6355%2C1864%2C1865%2C1866%2C1868%2C1869%2C2108%2C2110%2C2111%2C2112%2C2113%2C2114%2C2116%2C2146%2C2165%2C2330%2C3153%2C5221%2C5222%2C5284%2C5285%2C5965%2C6250%2C16595%2C2120%2C3604%2C2122%2C3017%2C3202%2C3948%2C3949%2C4036%2C4037%2C5248%2C5277%2C5684%2C5685%2C5686%2C5687%2C5699%2C6192%2C5717%2C5925%2C5968%2C5980%2C6214%2C6292%2C6426%2C6467%2C16542%2C16610%2C16611%2C16612%2C16613%2C16614%2C16615%2C16926%2C17135&mainOnly%5Bnews%5D=1';

    final response = await httpClient.get(materialUrl);
    print('MaterialItemRemoteDataSource: getLastMaterials statusCode: ${response.statusCode}');

    if(response.statusCode == 200){

      ChannelResponse channelResponse = ChannelResponse.fromJson(jsonDecode(response.body));

      Channel channel = channelResponse.channel;
      News news = channel.news;
      return news.materials.map((matItem) {
        try{
          matItemDao.insertMaterial(matItem);
        }catch(e, stackTrace){
          print('MaterialItemRemoteDataSource: getLastMaterials: exception: ${e.toString()}');
          //throw(e);
        }
      }).toList();
    }else{
      print('MaterialItemRemoteDataSource: getLastMaterials: Error fetching materialItems');
      throw Exception('Error fetching materialItems');
    }
  }

  Future<List<MaterialItem>> getPrevMaterials(String lastMatTimestamp) async{
    final String materialUrl = 'https://www.sport-express.ru/services/materials/mobile/?mainOnly%5Bphoto%5D=1&items=30&timestamp=$lastMatTimestamp&mainOnly%5Bvideo%5D=1&json=1&itemsloaded=0&mainOnly%5Bpress%5D=1&siteRubricIds=1873%2C3956%2C6432%2C16829%2C1875%2C1877%2C1878%2C1879%2C1908%2C1909%2C1910%2C5670%2C6201%2C1912%2C1913%2C1882%2C1883%2C1884%2C1885%2C1886%2C1887%2C1888%2C1889%2C1890%2C1891%2C1892%2C1893%2C1894%2C1895%2C1896%2C1897%2C1898%2C1899%2C1900%2C1901%2C1902%2C1903%2C1904%2C1905%2C1906%2C1907%2C2127%2C5620%2C5669%2C5734%2C5830%2C5905%2C5906%2C5938%2C5939%2C6050%2C6095%2C6097%2C6098%2C6106%2C6110%2C6119%2C6121%2C6222%2C6345%2C6424%2C6443%2C17094%2C17115%2C3972%2C16835%2C1915%2C1916%2C1917%2C1918%2C1919%2C1920%2C1921%2C1922%2C1923%2C1924%2C1925%2C6241%2C6289%2C6347%2C6478%2C16596%2C16837%2C17121%2C1928%2C1929%2C1930%2C1931%2C1932%2C16747%2C16748%2C16804%2C16805%2C1935%2C1936%2C1937%2C1938%2C1939%2C1940%2C1941%2C5935%2C1942%2C1943%2C17126%2C17127%2C17128%2C17129%2C6234%2C16958%2C16959%2C16960%2C1945%2C1946%2C1947%2C16802%2C16803%2C16735%2C16736%2C16808%2C16809%2C1951%2C1952%2C1953%2C1954%2C6090%2C6091%2C1808%2C16839%2C1955%2C1956%2C1957%2C1958%2C1810%2C1818%2C1964%2C1965%2C1966%2C1967%2C1968%2C1969%2C1970%2C1971%2C1972%2C1973%2C1974%2C1975%2C1976%2C1977%2C2329%2C3246%2C3247%2C3248%2C3249%2C3250%2C3251%2C3252%2C3253%2C3254%2C3255%2C3256%2C3257%2C3258%2C3259%2C3260%2C3262%2C3263%2C3264%2C3266%2C3267%2C3268%2C3269%2C3270%2C3271%2C3272%2C3273%2C3274%2C3275%2C3276%2C3278%2C3279%2C3280%2C3282%2C3284%2C3285%2C3286%2C3287%2C3288%2C3289%2C3347%2C5739%2C5741%2C5815%2C5816%2C5817%2C5818%2C5819%2C5820%2C5821%2C5822%2C5823%2C5824%2C5825%2C5826%2C5827%2C5974%2C1961%2C1978%2C1979%2C1980%2C1981%2C1982%2C1983%2C1984%2C1985%2C1986%2C1987%2C1988%2C1989%2C1990%2C1991%2C1992%2C1993%2C1994%2C1995%2C1996%2C1997%2C1998%2C1999%2C2000%2C2001%2C2002%2C2003%2C2004%2C2005%2C2006%2C2007%2C2008%2C2009%2C2010%2C2011%2C2012%2C2013%2C2014%2C3061%2C2030%2C2031%2C2032%2C6397%2C6400%2C16573%2C1813%2C1814%2C1815%2C1816%2C1819%2C1820%2C1821%2C2033%2C2034%2C1823%2C2035%2C2036%2C16810%2C16811%2C16812%2C16813%2C1825%2C1826%2C2039%2C2040%2C2041%2C1828%2C3099%2C3100%2C3101%2C1830%2C2042%2C2043%2C2044%2C2045%2C2046%2C2047%2C1832%2C1834%2C1835%2C1836%2C1837%2C1838%2C1839%2C1840%2C1841%2C1842%2C1843%2C1844%2C1845%2C1846%2C1847%2C1848%2C1849%2C2048%2C2049%2C1851%2C1852%2C1853%2C1854%2C1855%2C16952%2C16954%2C1857%2C1858%2C1859%2C1860%2C1861%2C1862%2C1863%2C6355%2C1864%2C1865%2C1866%2C1868%2C1869%2C2108%2C2110%2C2111%2C2112%2C2113%2C2114%2C2116%2C2146%2C2165%2C2330%2C3153%2C5221%2C5222%2C5284%2C5285%2C5965%2C6250%2C16595%2C2120%2C3604%2C2122%2C3017%2C3202%2C3948%2C3949%2C4036%2C4037%2C5248%2C5277%2C5684%2C5685%2C5686%2C5687%2C5699%2C6192%2C5717%2C5925%2C5968%2C5980%2C6214%2C6292%2C6426%2C6467%2C16542%2C16610%2C16611%2C16612%2C16613%2C16614%2C16615%2C16926%2C17135&mainOnly%5Bnews%5D=1';

    final response = await httpClient.get(materialUrl);

    if(response.statusCode == 200){

      ChannelResponse channelResponse = ChannelResponse.fromJson(jsonDecode(response.body));

      Channel channel = channelResponse.channel;
      News news = channel.news;
      return news.materials.map((matItem) {
        try{
          print('MaterialItemRemoteDataSource: getPrevMaterials: title: ${matItem.title}');
          matItemDao.insertMaterial(matItem);
        }catch(e, stackTrace){
          print('MaterialItemRemoteDataSource: getPrevMaterials: exception: ${e.toString()}');
          //throw(e);
        }
      }).toList();
    }else{
      print('MaterialItemRemoteDataSource: getPrevMaterials: Error fetching materialItems');
      throw Exception('Error fetching materialItems');
    }
  }

}

List<MaterialItem> parseChannel(String responseBody){
  ChannelResponse channelResponse = ChannelResponse.fromJson(jsonDecode(responseBody));

  Channel channel = channelResponse.channel;
  News news = channel.news;

  //print('MaterialItemRemoteDataSource: parseChannel: ${news.materials}');
  //return news.materials;
  return news.materials.map((matItem) {
      print('Insert material: ${matItem.title}');
      //DBProvider.db.insertMaterial(matItem);
      //matItemDao.insertMaterial(matItem);
    }).toList();

}


